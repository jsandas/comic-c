# https://nasm.us/
NASM ?= nasm
# http://www.delorie.com/djgpp/16bit/djlink/
DJLINK ?= djlink/djlink
GO ?= go

GRAPHICS := $(addprefix graphics/, $(addsuffix .ega, \
	$(foreach facing,right left, \
		comic_standing_$(facing)_16x32m \
		comic_running_1_$(facing)_16x32m \
		comic_running_2_$(facing)_16x32m \
		comic_running_3_$(facing)_16x32m \
		comic_jumping_$(facing)_16x32m \
	) \
	$(foreach i,0 1,fireball_$(i)_16x8m) \
	$(foreach i,0 1 2,white_spark_$(i)_16x16m) \
	$(foreach i,0 1 2,red_spark_$(i)_16x16m) \
	$(foreach i,0 1 2 3 4 5 6 7,comic_death_$(i)_16x32m) \
	$(foreach i,0 1 2,teleport_$(i)_16x32m) \
	$(foreach i,0 1 2 3 4 5 6 7 8 9 10 11,materialize_$(i)_16x32m) \
	$(foreach item,corkscrew door_key boots lantern teleport_wand gems crown gold blastola_cola shield, \
		$(foreach evenodd,even odd, \
			$(item)_$(evenodd)_16x16m \
		) \
	) \
	$(foreach i,1 2 3 4 5, \
		$(foreach evenodd,even odd, \
			blastola_cola_inventory_$(i)_$(evenodd)_16x16m \
		) \
	) \
	life_icon_bright_16x16m \
	life_icon_dark_16x16m \
	$(foreach i,0 1 2 3 4 5 6 7 8 9,score_digit_$(i)_8x16) \
	meter_empty_8x16 \
	meter_half_8x16 \
	meter_full_8x16 \
	pause_128x48 \
	game_over_128x48 \
	high_scores_320x200 \
))

all: R3sw1989.exe
.PHONY: all

djlink/djlink:
	(cd djlink && make djlink.exe) && mv -f djlink/djlink.exe "$@"

%.exe: %.obj
	"$(DJLINK)" -o "$@" $^

.INTERMEDIATE: %.obj
%.obj: %.asm R3_levels.asm $(GRAPHICS)
	"$(NASM)" -f obj -o "$@" "$<"

R3_levels.asm: ../../assets/extracted/unpacked.exe
	(echo "; Automatically generated by gen_levels.go"; "$(GO)" run gen_levels.go -- "$<" $$((0xf720))) > "$@"

# Extract data (like graphics) verbatim from the original executables.
graphics/%.ega:
	mkdir -p "$(dir $@)"
	dd if="$(EXE)" of="$@" bs=1 skip="$$((512+($(EXTRACT_SKIP))))" count="$$(($(EXTRACT_COUNT)))"

graphics/%.ega: EXE=../../assets/extracted/unpacked.exe

# Graphics have 4 EGA planes, 8 pixels per byte in each plane.
%_8x16.ega:    EXTRACT_COUNT=4*8*16/8
%_16x16.ega:   EXTRACT_COUNT=4*16*16/8
%_128x48.ega:  EXTRACT_COUNT=4*128*48/8
%_320x200.ega: EXTRACT_COUNT=4*320*200/8

# Masked graphics effectively add a fifth plane for transparency.
%_16x8m.ega:  EXTRACT_COUNT=5*16*8/8
%_16x16m.ega: EXTRACT_COUNT=5*16*16/8
%_16x32m.ega: EXTRACT_COUNT=5*16*32/8

graphics/comic_standing_right_16x32m.ega:  EXTRACT_SKIP=0x8e80+0*320
graphics/comic_running_1_right_16x32m.ega: EXTRACT_SKIP=0x8e80+1*320
graphics/comic_running_2_right_16x32m.ega: EXTRACT_SKIP=0x8e80+2*320
graphics/comic_running_3_right_16x32m.ega: EXTRACT_SKIP=0x8e80+3*320
graphics/comic_jumping_right_16x32m.ega:   EXTRACT_SKIP=0x8e80+4*320
graphics/comic_standing_left_16x32m.ega:   EXTRACT_SKIP=0x8e80+5*320
graphics/comic_running_1_left_16x32m.ega:  EXTRACT_SKIP=0x8e80+6*320
graphics/comic_running_2_left_16x32m.ega:  EXTRACT_SKIP=0x8e80+7*320
graphics/comic_running_3_left_16x32m.ega:  EXTRACT_SKIP=0x8e80+8*320
graphics/comic_jumping_left_16x32m.ega:    EXTRACT_SKIP=0x8e80+9*320

graphics/fireball_0_16x8m.ega: EXTRACT_SKIP=0x9b00+0*80
graphics/fireball_1_16x8m.ega: EXTRACT_SKIP=0x9b00+1*80

graphics/white_spark_0_16x16m.ega: EXTRACT_SKIP=0x9ba0+0*160
graphics/white_spark_1_16x16m.ega: EXTRACT_SKIP=0x9ba0+1*160
graphics/white_spark_2_16x16m.ega: EXTRACT_SKIP=0x9ba0+2*160

graphics/red_spark_0_16x16m.ega: EXTRACT_SKIP=0x9d80+0*160
graphics/red_spark_1_16x16m.ega: EXTRACT_SKIP=0x9d80+1*160
graphics/red_spark_2_16x16m.ega: EXTRACT_SKIP=0x9d80+2*160

graphics/comic_death_0_16x32m.ega: EXTRACT_SKIP=0x9f60+0*320
graphics/comic_death_1_16x32m.ega: EXTRACT_SKIP=0x9f60+1*320
graphics/comic_death_2_16x32m.ega: EXTRACT_SKIP=0x9f60+2*320
graphics/comic_death_3_16x32m.ega: EXTRACT_SKIP=0x9f60+3*320
graphics/comic_death_4_16x32m.ega: EXTRACT_SKIP=0x9f60+4*320
graphics/comic_death_5_16x32m.ega: EXTRACT_SKIP=0x9f60+5*320
graphics/comic_death_6_16x32m.ega: EXTRACT_SKIP=0x9f60+6*320
graphics/comic_death_7_16x32m.ega: EXTRACT_SKIP=0x9f60+7*320

graphics/teleport_0_16x32m.ega: EXTRACT_SKIP=0xa960+0*320
graphics/teleport_1_16x32m.ega: EXTRACT_SKIP=0xa960+1*320
graphics/teleport_2_16x32m.ega: EXTRACT_SKIP=0xa960+2*320

graphics/materialize_0_16x32m.ega:  EXTRACT_SKIP=0xad20+0*320
graphics/materialize_1_16x32m.ega:  EXTRACT_SKIP=0xad20+1*320
graphics/materialize_2_16x32m.ega:  EXTRACT_SKIP=0xad20+2*320
graphics/materialize_3_16x32m.ega:  EXTRACT_SKIP=0xad20+3*320
graphics/materialize_4_16x32m.ega:  EXTRACT_SKIP=0xad20+4*320
graphics/materialize_5_16x32m.ega:  EXTRACT_SKIP=0xad20+5*320
graphics/materialize_6_16x32m.ega:  EXTRACT_SKIP=0xad20+6*320
graphics/materialize_7_16x32m.ega:  EXTRACT_SKIP=0xad20+7*320
graphics/materialize_8_16x32m.ega:  EXTRACT_SKIP=0xad20+8*320
graphics/materialize_9_16x32m.ega:  EXTRACT_SKIP=0xad20+9*320
graphics/materialize_10_16x32m.ega: EXTRACT_SKIP=0xad20+10*320
graphics/materialize_11_16x32m.ega: EXTRACT_SKIP=0xad20+11*320

# "Even" and "odd" frames are separated from each other by a fixed
# distance of 0xa00 bytes.
graphics/corkscrew_even_16x16m.ega:     EXTRACT_SKIP=0xbc44+0x000+0*160
graphics/door_key_even_16x16m.ega:      EXTRACT_SKIP=0xbc44+0x000+1*160
graphics/boots_even_16x16m.ega:         EXTRACT_SKIP=0xbc44+0x000+2*160
graphics/lantern_even_16x16m.ega:       EXTRACT_SKIP=0xbc44+0x000+3*160
graphics/teleport_wand_even_16x16m.ega: EXTRACT_SKIP=0xbc44+0x000+4*160
graphics/gems_even_16x16m.ega:          EXTRACT_SKIP=0xbc44+0x000+5*160
graphics/crown_even_16x16m.ega:         EXTRACT_SKIP=0xbc44+0x000+6*160
graphics/gold_even_16x16m.ega:          EXTRACT_SKIP=0xbc44+0x000+7*160
graphics/blastola_cola_even_16x16m.ega: EXTRACT_SKIP=0xbc44+0x000+8*160
graphics/shield_even_16x16m.ega:        EXTRACT_SKIP=0xbc44+0x000+14*160
#
graphics/corkscrew_odd_16x16m.ega:      EXTRACT_SKIP=0xbc44+0xa00+0*160
graphics/door_key_odd_16x16m.ega:       EXTRACT_SKIP=0xbc44+0xa00+1*160
graphics/boots_odd_16x16m.ega:          EXTRACT_SKIP=0xbc44+0xa00+2*160
graphics/lantern_odd_16x16m.ega:        EXTRACT_SKIP=0xbc44+0xa00+3*160
graphics/teleport_wand_odd_16x16m.ega:  EXTRACT_SKIP=0xbc44+0xa00+4*160
graphics/gems_odd_16x16m.ega:           EXTRACT_SKIP=0xbc44+0xa00+5*160
graphics/crown_odd_16x16m.ega:          EXTRACT_SKIP=0xbc44+0xa00+6*160
graphics/gold_odd_16x16m.ega:           EXTRACT_SKIP=0xbc44+0xa00+7*160
graphics/blastola_cola_odd_16x16m.ega:  EXTRACT_SKIP=0xbc44+0xa00+8*160
graphics/shield_odd_16x16m.ega:         EXTRACT_SKIP=0xbc44+0xa00+14*160

graphics/blastola_cola_inventory_1_even_16x16m.ega: EXTRACT_SKIP=0xc144+0x000+1*160
graphics/blastola_cola_inventory_2_even_16x16m.ega: EXTRACT_SKIP=0xc144+0x000+2*160
graphics/blastola_cola_inventory_3_even_16x16m.ega: EXTRACT_SKIP=0xc144+0x000+3*160
graphics/blastola_cola_inventory_4_even_16x16m.ega: EXTRACT_SKIP=0xc144+0x000+4*160
graphics/blastola_cola_inventory_5_even_16x16m.ega: EXTRACT_SKIP=0xc144+0x000+5*160
graphics/blastola_cola_inventory_1_odd_16x16m.ega:  EXTRACT_SKIP=0xc144+0xa00+1*160
graphics/blastola_cola_inventory_2_odd_16x16m.ega:  EXTRACT_SKIP=0xc144+0xa00+2*160
graphics/blastola_cola_inventory_3_odd_16x16m.ega:  EXTRACT_SKIP=0xc144+0xa00+3*160
graphics/blastola_cola_inventory_4_odd_16x16m.ega:  EXTRACT_SKIP=0xc144+0xa00+4*160
graphics/blastola_cola_inventory_5_odd_16x16m.ega:  EXTRACT_SKIP=0xc144+0xa00+5*160

graphics/life_icon_bright_16x16m.ega: EXTRACT_SKIP=0xc5a4+0x000
graphics/life_icon_dark_16x16m.ega:   EXTRACT_SKIP=0xc5a4+0xa00

graphics/score_digit_0_8x16.ega: EXTRACT_SKIP=0xd044+0*64
graphics/score_digit_1_8x16.ega: EXTRACT_SKIP=0xd044+1*64
graphics/score_digit_2_8x16.ega: EXTRACT_SKIP=0xd044+2*64
graphics/score_digit_3_8x16.ega: EXTRACT_SKIP=0xd044+3*64
graphics/score_digit_4_8x16.ega: EXTRACT_SKIP=0xd044+4*64
graphics/score_digit_5_8x16.ega: EXTRACT_SKIP=0xd044+5*64
graphics/score_digit_6_8x16.ega: EXTRACT_SKIP=0xd044+6*64
graphics/score_digit_7_8x16.ega: EXTRACT_SKIP=0xd044+7*64
graphics/score_digit_8_8x16.ega: EXTRACT_SKIP=0xd044+8*64
graphics/score_digit_9_8x16.ega: EXTRACT_SKIP=0xd044+9*64

graphics/meter_empty_8x16.ega: EXTRACT_SKIP=0xd2c4
graphics/meter_half_8x16.ega:  EXTRACT_SKIP=0xd304
graphics/meter_full_8x16.ega:  EXTRACT_SKIP=0xd344

graphics/pause_128x48.ega: EXTRACT_SKIP=0xd384
graphics/game_over_128x48.ega: EXTRACT_SKIP=0xdf84

graphics/high_scores_320x200.ega: EXTRACT_SKIP=0xfdd0

.DELETE_ON_ERROR:
